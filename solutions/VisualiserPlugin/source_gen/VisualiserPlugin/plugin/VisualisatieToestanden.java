package VisualiserPlugin.plugin;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import java.io.PrintWriter;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.internal.collections.runtime.IWhereFilter;
import jetbrains.mps.internal.collections.runtime.ISelector;
import com.intellij.openapi.project.Project;
import jetbrains.mps.workbench.MPSDataKeys;
import com.intellij.ide.DataManager;
import com.intellij.platform.ProjectBaseDirectory;
import java.io.File;
import java.io.IOException;
import java.io.FileNotFoundException;
import java.io.BufferedReader;
import java.io.InputStreamReader;

public class VisualisatieToestanden {
  public void WriteToFile(SNode context) {
    System.out.println("Initialiseer bestand voor context: " + context);
    PrintWriter gvWriter = InitialiseFile();
    gvWriter.append("## Graphviz file voor toestanden gegenereerd vanuit MPS" + "\n");
    gvWriter.append("##-----------------------------------------------------" + "\n");
    gvWriter.append("\n");
    gvWriter.append("\n");
    gvWriter.append("##Command to produce the output: neato -Tpng thisfile > thisfile.png" + "\n");
    gvWriter.append("\n");
    gvWriter.append("\n");
    gvWriter.append("digraph diagram" + "{" + "\n");
    gvWriter.append("rankdir=LR;" + "\n");
    gvWriter.append("\n");
    // Alle toestanden wegschrijven 
    gvWriter.append("node [shape=box, fixedsize=true, width=3];");
    for (SNode toestand : ListSequence.fromList(SLinkOperations.getChildren(context, MetaAdapterFactory.getContainmentLink(0x8dc4b25f4c49400eL, 0xac370fd230db702cL, 0x611073d615228d02L, 0x202912d6e3a8c9baL, "toestanden")))) {
      {
        final SNode rechtsbetrekking = toestand;
        if (SNodeOperations.isInstanceOf(rechtsbetrekking, MetaAdapterFactory.getConcept(0x8dc4b25f4c49400eL, 0xac370fd230db702cL, 0x611073d615228d0dL, "ObjectiefRecht.structure.Rechtsbetrekking"))) {
          if (SPropertyOperations.getBoolean(rechtsbetrekking, MetaAdapterFactory.getProperty(0x8dc4b25f4c49400eL, 0xac370fd230db702cL, 0x611073d615228d0dL, 0x25be3715c7da8818L, "initieel")) == false) {
            gvWriter.append("\"" + addCRLFtoString(SPropertyOperations.getString(rechtsbetrekking, MetaAdapterFactory.getProperty(0xf856d46f333847a8L, 0x8a4811e26bc535e0L, 0x12f338eae6fd9441L, 0x12f338eae6fd9458L, "kortenaam"))) + "\"" + "; ");
          }
          if (SPropertyOperations.getBoolean(rechtsbetrekking, MetaAdapterFactory.getProperty(0x8dc4b25f4c49400eL, 0xac370fd230db702cL, 0x611073d615228d0dL, 0x25be3715c7da8818L, "initieel")) == true) {
            gvWriter.append("\"" + addCRLFtoString(SPropertyOperations.getString(rechtsbetrekking, MetaAdapterFactory.getProperty(0xf856d46f333847a8L, 0x8a4811e26bc535e0L, 0x12f338eae6fd9441L, 0x12f338eae6fd9458L, "kortenaam"))) + "\"" + "[color=lightblue, style=filled]" + "; ");
          }
        }
      }
      {
        final SNode betrekking = toestand;
        if (SNodeOperations.isInstanceOf(betrekking, MetaAdapterFactory.getConcept(0x8dc4b25f4c49400eL, 0xac370fd230db702cL, 0x3b19ba47355a8fe7L, "ObjectiefRecht.structure.Betrekking"))) {
          gvWriter.append("\"" + addCRLFtoString(SPropertyOperations.getString(betrekking, MetaAdapterFactory.getProperty(0xf856d46f333847a8L, 0x8a4811e26bc535e0L, 0x12f338eae6fd9441L, 0x12f338eae6fd9458L, "kortenaam"))) + "\"" + "[color=lightgray, style=filled]" + "; ");
        }
      }
    }
    gvWriter.append("\n");

    for (SNode overgang : ListSequence.fromList(SLinkOperations.getChildren(context, MetaAdapterFactory.getContainmentLink(0x8dc4b25f4c49400eL, 0xac370fd230db702cL, 0x611073d615228d02L, 0x202912d6e3af3604L, "overgangen")))) {
      {
        final SNode rechtshandeling = overgang;
        if (SNodeOperations.isInstanceOf(rechtshandeling, MetaAdapterFactory.getConcept(0x8dc4b25f4c49400eL, 0xac370fd230db702cL, 0x611073d615228d3dL, "ObjectiefRecht.structure.Rechtshandeling"))) {
          for (SNode rechtsbetrekking : ListSequence.fromList(SLinkOperations.getChildren(SLinkOperations.getTarget(rechtshandeling, MetaAdapterFactory.getContainmentLink(0x8dc4b25f4c49400eL, 0xac370fd230db702cL, 0x611073d615228d3aL, 0x202912d6e3ac6d26L, "heeftAlsGevolg")), MetaAdapterFactory.getContainmentLink(0x8dc4b25f4c49400eL, 0xac370fd230db702cL, 0x611073d615228d77L, 0x611073d615228d78L, "NieuweRechtsbetrekkingen"))).where(new IWhereFilter<SNode>() {
            public boolean accept(SNode it) {
              return (SLinkOperations.getTarget(it, MetaAdapterFactory.getReferenceLink(0x8dc4b25f4c49400eL, 0xac370fd230db702cL, 0x202912d6e3aabf26L, 0x202912d6e3aabf27L, "rechtsbetrekking")) != null);
            }
          }).select(new ISelector<SNode, SNode>() {
            public SNode select(SNode it) {
              return SLinkOperations.getTarget(it, MetaAdapterFactory.getReferenceLink(0x8dc4b25f4c49400eL, 0xac370fd230db702cL, 0x202912d6e3aabf26L, 0x202912d6e3aabf27L, "rechtsbetrekking"));
            }
          })) {
            gvWriter.append("\"" + addCRLFtoString(GeefBijbehorendeToestand(context, overgang)) + "\"" + "->" + "\"" + addCRLFtoString(SPropertyOperations.getString(rechtsbetrekking, MetaAdapterFactory.getProperty(0xf856d46f333847a8L, 0x8a4811e26bc535e0L, 0x12f338eae6fd9441L, 0x12f338eae6fd9458L, "kortenaam"))) + "\"" + " [ label = " + "\"" + addCRLFtoString(SPropertyOperations.getString(overgang, MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name"))) + "\"" + ", arrowhead=normal, arrowsize=1.2, minlen=2 ];" + "\n");
          }
        }
      }
      {
        final SNode handelingZonderRechtsgevolg = overgang;
        if (SNodeOperations.isInstanceOf(handelingZonderRechtsgevolg, MetaAdapterFactory.getConcept(0x8dc4b25f4c49400eL, 0xac370fd230db702cL, 0x25299d15220b0f46L, "ObjectiefRecht.structure.HandelingZonderRechtsgevolg"))) {
          for (SNode rechtsbetrekking : ListSequence.fromList(SLinkOperations.getChildren(SLinkOperations.getTarget(handelingZonderRechtsgevolg, MetaAdapterFactory.getContainmentLink(0x8dc4b25f4c49400eL, 0xac370fd230db702cL, 0x611073d615228d3aL, 0x202912d6e3ac6d26L, "heeftAlsGevolg")), MetaAdapterFactory.getContainmentLink(0x8dc4b25f4c49400eL, 0xac370fd230db702cL, 0x611073d615228d77L, 0x611073d615228d78L, "NieuweRechtsbetrekkingen"))).where(new IWhereFilter<SNode>() {
            public boolean accept(SNode it) {
              return (SLinkOperations.getTarget(it, MetaAdapterFactory.getReferenceLink(0x8dc4b25f4c49400eL, 0xac370fd230db702cL, 0x202912d6e3aabf26L, 0x202912d6e3aabf27L, "rechtsbetrekking")) != null);
            }
          }).select(new ISelector<SNode, SNode>() {
            public SNode select(SNode it) {
              return SLinkOperations.getTarget(it, MetaAdapterFactory.getReferenceLink(0x8dc4b25f4c49400eL, 0xac370fd230db702cL, 0x202912d6e3aabf26L, 0x202912d6e3aabf27L, "rechtsbetrekking"));
            }
          })) {
            gvWriter.append("\"" + addCRLFtoString(GeefBijbehorendeToestand(context, overgang)) + "\"" + "->" + "\"" + addCRLFtoString(SPropertyOperations.getString(rechtsbetrekking, MetaAdapterFactory.getProperty(0xf856d46f333847a8L, 0x8a4811e26bc535e0L, 0x12f338eae6fd9441L, 0x12f338eae6fd9458L, "kortenaam"))) + "\"" + " [ label = " + "\"" + addCRLFtoString(SPropertyOperations.getString(overgang, MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name"))) + "\"" + ", arrowhead=vee, arrowsize=1.2, minlen=2  ];" + "\n");
          }
        }
      }
    }

    gvWriter.append("overlap=false" + "\n");
    gvWriter.append("fontsize=14;" + "\n");
    gvWriter.append("}");
    gvWriter.close();
    TransformToPng();
  }
  public String GeefBijbehorendeToestand(SNode context, SNode overgang) {
    String resultaat = "";
    for (SNode toestand : ListSequence.fromList(SLinkOperations.getChildren(context, MetaAdapterFactory.getContainmentLink(0x8dc4b25f4c49400eL, 0xac370fd230db702cL, 0x611073d615228d02L, 0x202912d6e3a8c9baL, "toestanden")))) {
      {
        final SNode aanspraakNaIngebrekeStellingPlicht = toestand;
        if (SNodeOperations.isInstanceOf(aanspraakNaIngebrekeStellingPlicht, MetaAdapterFactory.getConcept(0x8dc4b25f4c49400eL, 0xac370fd230db702cL, 0x611073d615228d93L, "ObjectiefRecht.structure.AanspraakNaIngebrekeStellingPlicht"))) {
          if (SLinkOperations.getTarget(aanspraakNaIngebrekeStellingPlicht, MetaAdapterFactory.getReferenceLink(0x8dc4b25f4c49400eL, 0xac370fd230db702cL, 0x611073d615228d93L, 0x3bfdb51c6ba50297L, "verplichtingTot")) == overgang) {
            resultaat = SPropertyOperations.getString(toestand, MetaAdapterFactory.getProperty(0xf856d46f333847a8L, 0x8a4811e26bc535e0L, 0x12f338eae6fd9441L, 0x12f338eae6fd9458L, "kortenaam"));
          }
        }
      }
      {
        final SNode immuniteitGeenbevoegdheid = toestand;
        if (SNodeOperations.isInstanceOf(immuniteitGeenbevoegdheid, MetaAdapterFactory.getConcept(0x8dc4b25f4c49400eL, 0xac370fd230db702cL, 0x611073d615228d95L, "ObjectiefRecht.structure.ImmuniteitGeenbevoegdheid"))) {
          if (SLinkOperations.getTarget(immuniteitGeenbevoegdheid, MetaAdapterFactory.getReferenceLink(0x8dc4b25f4c49400eL, 0xac370fd230db702cL, 0x611073d615228d95L, 0x3bfdb51c6ba5108fL, "uittevoeren")) == overgang) {
            resultaat = SPropertyOperations.getString(toestand, MetaAdapterFactory.getProperty(0xf856d46f333847a8L, 0x8a4811e26bc535e0L, 0x12f338eae6fd9441L, 0x12f338eae6fd9458L, "kortenaam"));
          }
        }
      }
      {
        final SNode krachtigeAanspraakFataleVerplichtig = toestand;
        if (SNodeOperations.isInstanceOf(krachtigeAanspraakFataleVerplichtig, MetaAdapterFactory.getConcept(0x8dc4b25f4c49400eL, 0xac370fd230db702cL, 0x611073d615228d97L, "ObjectiefRecht.structure.KrachtigeAanspraakFataleVerplichtig"))) {
          if (SLinkOperations.getTarget(krachtigeAanspraakFataleVerplichtig, MetaAdapterFactory.getReferenceLink(0x8dc4b25f4c49400eL, 0xac370fd230db702cL, 0x611073d615228d97L, 0x3bfdb51c6ba51ed1L, "verplichtingTot")) == overgang) {
            resultaat = SPropertyOperations.getString(toestand, MetaAdapterFactory.getProperty(0xf856d46f333847a8L, 0x8a4811e26bc535e0L, 0x12f338eae6fd9441L, 0x12f338eae6fd9458L, "kortenaam"));
          }
        }
      }
      {
        final SNode optioneleBevoegdheidOptioneleGehoudenheid = toestand;
        if (SNodeOperations.isInstanceOf(optioneleBevoegdheidOptioneleGehoudenheid, MetaAdapterFactory.getConcept(0x8dc4b25f4c49400eL, 0xac370fd230db702cL, 0x611073d615228d98L, "ObjectiefRecht.structure.OptioneleBevoegdheidOptioneleGehoudenheid"))) {
          if (SLinkOperations.getTarget(optioneleBevoegdheidOptioneleGehoudenheid, MetaAdapterFactory.getReferenceLink(0x8dc4b25f4c49400eL, 0xac370fd230db702cL, 0x611073d615228d98L, 0x3bfdb51c6ba51ed6L, "bevoegdheidTot")) == overgang) {
            resultaat = SPropertyOperations.getString(toestand, MetaAdapterFactory.getProperty(0xf856d46f333847a8L, 0x8a4811e26bc535e0L, 0x12f338eae6fd9441L, 0x12f338eae6fd9458L, "kortenaam"));
          }
        }
      }
      {
        final SNode verplichteBevoegdheidVerplichteGehoudenheid = toestand;
        if (SNodeOperations.isInstanceOf(verplichteBevoegdheidVerplichteGehoudenheid, MetaAdapterFactory.getConcept(0x8dc4b25f4c49400eL, 0xac370fd230db702cL, 0x611073d615228d94L, "ObjectiefRecht.structure.VerplichteBevoegdheidVerplichteGehoudenheid"))) {
          if (SLinkOperations.getTarget(verplichteBevoegdheidVerplichteGehoudenheid, MetaAdapterFactory.getReferenceLink(0x8dc4b25f4c49400eL, 0xac370fd230db702cL, 0x611073d615228d94L, 0x3bfdb51c6ba53ac9L, "bevoegdheidTot")) == overgang) {
            resultaat = SPropertyOperations.getString(toestand, MetaAdapterFactory.getProperty(0xf856d46f333847a8L, 0x8a4811e26bc535e0L, 0x12f338eae6fd9441L, 0x12f338eae6fd9458L, "kortenaam"));
          }
        }
      }
      {
        final SNode zwakkeAanspraakZwakkePlicht = toestand;
        if (SNodeOperations.isInstanceOf(zwakkeAanspraakZwakkePlicht, MetaAdapterFactory.getConcept(0x8dc4b25f4c49400eL, 0xac370fd230db702cL, 0x611073d615228d96L, "ObjectiefRecht.structure.ZwakkeAanspraakZwakkePlicht"))) {
          if (SLinkOperations.getTarget(zwakkeAanspraakZwakkePlicht, MetaAdapterFactory.getReferenceLink(0x8dc4b25f4c49400eL, 0xac370fd230db702cL, 0x611073d615228d96L, 0x3bfdb51c6ba54be5L, "verplichtingTot")) == overgang) {
            resultaat = SPropertyOperations.getString(toestand, MetaAdapterFactory.getProperty(0xf856d46f333847a8L, 0x8a4811e26bc535e0L, 0x12f338eae6fd9441L, 0x12f338eae6fd9458L, "kortenaam"));
          }
        }
      }
      {
        final SNode betrekking = toestand;
        if (SNodeOperations.isInstanceOf(betrekking, MetaAdapterFactory.getConcept(0x8dc4b25f4c49400eL, 0xac370fd230db702cL, 0x3b19ba47355a8fe7L, "ObjectiefRecht.structure.Betrekking"))) {
          if (SLinkOperations.getTarget(betrekking, MetaAdapterFactory.getReferenceLink(0x8dc4b25f4c49400eL, 0xac370fd230db702cL, 0x3b19ba47355a8fe7L, 0x75a9691d14834680L, "overgang")) == overgang) {
            resultaat = SPropertyOperations.getString(toestand, MetaAdapterFactory.getProperty(0xf856d46f333847a8L, 0x8a4811e26bc535e0L, 0x12f338eae6fd9441L, 0x12f338eae6fd9458L, "kortenaam"));
          }
        }
      }
    }
    return resultaat;
  }

  /*package*/ PrintWriter InitialiseFile() {
    PrintWriter writer = null;

    Project project = MPSDataKeys.PROJECT.getData(DataManager.getInstance().getDataContext());
    String graphvizfile = ProjectBaseDirectory.getInstance(project).getBaseDir().getCanonicalPath() + "/graphviz/visualiser.gv";
    System.out.println("File: " + graphvizfile);
    File file = new File(graphvizfile);
    if (file.exists() == false) {
      try {
        file.createNewFile();
        System.out.println("File created");
      } catch (IOException e) {
        System.out.println("GraphVizFile: IO Exception in creating file");
      }
    }
    try {
      writer = new PrintWriter(file);
      System.out.println("Writer created");
    } catch (FileNotFoundException e) {
      System.out.println("GraphVizFile: File not found");
    }
    return writer;
  }
  /*package*/ void TransformToPng() {
    Project project = MPSDataKeys.PROJECT.getData(DataManager.getInstance().getDataContext());
    String filegv = ProjectBaseDirectory.getInstance(project).getBaseDir().getCanonicalPath() + "/graphviz/visualiser.gv";
    String filepng = ProjectBaseDirectory.getInstance(project).getBaseDir().getCanonicalPath() + "/graphviz/visualiser.png";
    String[] commandarray = {"/bin/sh", "-c", "neato " + "-Tpng " + filegv + " > " + filepng};
    System.out.println("Running command");
    String result = ExecuteCommand(commandarray);
    System.out.println("Command executed with result" + result);
  }
  /*package*/ String ExecuteCommand(String[] command) {
    StringBuffer output = new StringBuffer();

    Process process;
    try {
      process = Runtime.getRuntime().exec(command);
      System.out.println("Wait for process");
      process.waitFor();
      System.out.println("Now Process output of command");
      BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream()));
      String line = "";
      while ((line = reader.readLine()) != null) {
        output.append(line);
      }
    } catch (Exception e) {
      e.printStackTrace();
    }
    return output.toString();
  }
  /*package*/ String addCRLFtoString(String inputstring) {
    int positieSpatie = inputstring.length() / 2;
    int index = inputstring.length() / 2;
    System.out.println(inputstring + "Nummer " + index + inputstring.charAt(index));
    while ((index < inputstring.length()) && (!(Character.isSpaceChar(inputstring.charAt(index))))) {
      positieSpatie = index;
      index++;
      System.out.println("Nummer " + index + inputstring.charAt(index));
    }
    return inputstring.substring(0, positieSpatie + 1) + "\n" + inputstring.substring(positieSpatie + 1, inputstring.length());
  }
}
